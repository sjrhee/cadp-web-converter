<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>CADP Web Converter - Wizard</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <style>
        .step-container {
            display: none;
        }

        .step-container.active {
            display: block;
        }

        .preview-table-container {
            max-height: 300px;
            overflow: auto;
        }

        .clickable-header {
            cursor: pointer;
            background-color: #f8f9fa;
        }

        .clickable-header:hover {
            background-color: #e9ecef;
        }

        .clickable-header.selected {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>CADP Web File Converter</h1>
            <p class="lead">Securely Encrypt or Decrypt CSV/TSV Files</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress mb-4" style="height: 25px;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 20%;" aria-valuenow="20"
                aria-valuemin="0" aria-valuemax="100">Step 1</div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-4">

                <!-- Step 1: Mode Selection -->
                <div id="step1" class="step-container active">
                    <h3>Step 1: Select Operation Mode</h3>
                    <div class="form-check my-3">
                        <input class="form-check-input" type="radio" name="mode" id="modeProtect" value="protect"
                            checked>
                        <label class="form-check-label" for="modeProtect"><strong>Protect (Encrypt)</strong> - Encrypt
                            specific columns in your file.</label>
                    </div>
                    <div class="form-check my-3">
                        <input class="form-check-input" type="radio" name="mode" id="modeReveal" value="reveal">
                        <label class="form-check-label" for="modeReveal"><strong>Reveal (Decrypt)</strong> - Decrypt
                            specific columns in your file.</label>
                    </div>
                    <div class="mt-4 text-end">
                        <button class="btn btn-primary" onclick="goToStep(2)">Next <i
                                class="bi bi-arrow-right"></i></button>
                    </div>
                </div>

                <!-- Step 2: File & Column Selection -->
                <div id="step2" class="step-container">
                    <h3>Step 2: Upload File & Select Column</h3>
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Select File (CSV/TSV)</label>
                        <input class="form-control" type="file" id="fileInput" accept=".csv,.tsv,.txt">
                    </div>
                    <div class="row g-3 align-items-center mb-3">
                        <div class="col-auto">
                            <label for="delimiterInput" class="col-form-label">Delimiter:</label>
                        </div>
                        <div class="col-auto">
                            <input type="text" id="delimiterInput" class="form-control" value=","
                                style="width: 60px; text-align: center;">
                        </div>
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skipHeaderCheck"
                                    onchange="if(previewData) renderTable(previewData)">
                                <label class="form-check-label" for="skipHeaderCheck">Skip Header Row</label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-secondary btn-sm" onclick="loadPreview()">Load Preview</button>
                        </div>
                    </div>

                    <div id="previewArea" class="d-none">
                        <p class="text-muted small">Click on a column header (Index 0, 1, 2...) to select the target
                            column for processing.</p>
                        <div class="preview-table-container border rounded">
                            <table class="table table-bordered table-sm mb-0">
                                <thead id="previewHeader"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <strong>Selected Column Index: </strong> <span id="selectedColIndex"
                                class="badge bg-primary">-</span>
                            <input type="hidden" id="targetColumnInput">
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-between">
                        <button class="btn btn-outline-secondary" onclick="goToStep(1)">Back</button>
                        <button class="btn btn-primary" id="step2NextBtn" onclick="goToStep(3)" disabled>Next</button>
                    </div>
                </div>

                <!-- Step 3: Configuration -->
                <div id="step3" class="step-container">
                    <h3>Step 3: Configuration & Policy</h3>
                    <p class="text-muted">Review default environment variables and modify if necessary.</p>
                    <form id="configForm">
                        <div class="row mb-3">
                            <label class="col-sm-3 col-form-label">CADP Host IP</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="confHost">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label class="col-sm-3 col-form-label">CADP Port</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="confPort">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label class="col-sm-3 col-form-label">Registration Token</label>
                            <div class="col-sm-9">
                                <input type="password" class="form-control" id="confToken"
                                    placeholder="Enter new token if needed">

                            </div>
                        </div>
                        <div class="row mb-3">
                            <label class="col-sm-3 col-form-label">User Name</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="confUser">
                            </div>
                        </div>
                        <hr>
                        <div class="row mb-3">
                            <label class="col-sm-3 col-form-label fw-bold">Policy Name</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="policyInput" required
                                    placeholder="required">
                            </div>
                        </div>
                    </form>

                    <div class="mt-4 d-flex justify-content-between">
                        <button class="btn btn-outline-secondary" onclick="goToStep(2)">Back</button>
                        <button class="btn btn-primary" onclick="goToStep(4)">Next</button>
                    </div>
                </div>

                <!-- Step 4: Execution -->
                <div id="step4" class="step-container">
                    <h3>Step 4: Execute Processing</h3>
                    <div class="alert alert-info">
                        <strong>Ready to Process?</strong><br>
                        File: <span id="summaryFile"></span><br>
                        Mode: <span id="summaryMode"></span><br>
                        Column: <span id="summaryCol"></span><br>
                        Policy: <span id="summaryPolicy"></span>
                    </div>

                    <div id="processingStatus" class="d-none text-center py-5">
                        <!-- Upload Progress -->
                        <div id="uploadProgressContainer" class="mb-3">
                            <label>Uploading to Server...</label>
                            <div class="progress" style="height: 20px;">
                                <div id="uploadProgressBar"
                                    class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                    role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>

                        <!-- Processing Status -->
                        <div id="serverProcessingContainer" class="d-none">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <h5 class="mt-3">Processing File...</h5>
                            <p class="lead">
                                Processed: <span id="procLines" class="fw-bold">0</span>
                                <span id="totalLinesContainer" class="d-none"> / <span id="procTotal">0</span></span>
                            </p>
                            <p class="text-danger" id="procErrorsContainer" style="display:none;">Errors: <span
                                    id="procErrors">0</span></p>
                        </div>
                    </div>

                    <div id="executionError" class="alert alert-danger d-none"></div>

                    <!-- Thread Configuration -->
                    <div class="row mb-3 align-items-center justify-content-end">
                        <div class="col-auto">
                            <label for="threadCountInput" class="col-form-label fw-bold">Threads:</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" id="threadCountInput" class="form-control" value="4" min="1" max="128"
                                style="width: 80px;">
                        </div>
                        <div class="col-auto">
                            <span class="text-muted small" data-bs-toggle="tooltip"
                                title="Higher threads usage increases CPU load but may speed up processing. Default is 4.">(Info)</span>
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-between" id="step4Controls">
                        <button class="btn btn-outline-secondary" onclick="goToStep(3)">Back</button>
                        <button class="btn btn-success" onclick="runProcess()">Run Processing</button>
                    </div>
                </div>

                <!-- Step 5: Result -->
                <div id="step5" class="step-container">
                    <div class="text-center text-success mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor"
                            class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                            <path
                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                        </svg>
                        <h2 class="mt-3">Processing Complete!</h2>

                        <div id="processingStats" class="alert alert-info mt-3 text-start d-inline-block px-4 d-none">
                            <p class="mb-1"><strong>Start Time:</strong> <span id="statStartTime">-</span></p>
                            <p class="mb-1"><strong>End Time:</strong> <span id="statEndTime">-</span></p>
                            <p class="mb-1"><strong>Lines:</strong> <span id="statLines">-</span></p>
                            <p class="mb-1 text-danger"><strong>Errors:</strong> <span id="statErrors">0</span></p>
                            <p class="mb-0"><strong>Duration:</strong> <span id="statDuration">-</span></p>
                        </div>
                    </div>

                    <h5>Result Preview (First 8 Lines)</h5>
                    <pre id="resultPreviewContent" class="bg-dark text-white p-3 rounded"
                        style="max-height: 200px; overflow: auto;"></pre>

                    <div class="text-center mt-5">
                        <a id="downloadLink" href="#" class="btn btn-lg btn-primary px-5">Download Processed File</a>
                        <button class="btn btn-link mt-3 d-block mx-auto" onclick="location.reload()">Start
                            Over</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedColIndices = [];
        let originalToken = "";
        let previewData = null;
        let pollInterval = null;

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('skipHeaderCheck').addEventListener('change', function () {
                if (previewData) {
                    renderTable(previewData);
                }
            });
        });

        function goToStep(step) {
            // Validation
            if (step === 3 && selectedColIndices.length === 0) {
                alert("Please select at least one target column.");
                return;
            }
            if (step === 4) {
                const policy = document.getElementById('policyInput').value;
                if (!policy) {
                    alert("Policy Name is required.");
                    return;
                }
                updateSummary();
            }

            // Hide all steps
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            // Show target step
            document.getElementById('step' + step).classList.add('active');

            // Update Wizard Progress
            const progress = step * 20;
            const bar = document.getElementById('progressBar');
            bar.style.width = progress + '%';
            bar.innerText = 'Step ' + step;

            currentStep = step;

            if (step === 3) {
                loadConfig();
            }
        }

        async function loadPreview() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                alert("Please select a file first.");
                return;
            }

            const formData = new FormData();
            // Performance Optimization: Slice the file (header + first few lines only)
            // 50KB should be enough for header + 8 lines even with very long lines
            const CHUNK_SIZE = 50 * 1024;
            const originalFile = fileInput.files[0];
            const blob = originalFile.slice(0, CHUNK_SIZE);

            // Append with original filename so backend can see the extension (csv/tsv) if needed
            formData.append("file", blob, originalFile.name);
            formData.append("delimiter", document.getElementById('delimiterInput').value);

            try {
                const response = await fetch('/api/preview', { method: 'POST', body: formData });
                if (!response.ok) throw new Error("Failed to load preview");

                previewData = await response.json();
                renderTable(previewData);
                document.getElementById('previewArea').classList.remove('d-none');
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function renderTable(data) {
            const thead = document.getElementById('previewHeader');
            const tbody = document.getElementById('previewBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (!data.rows || data.rows.length === 0) return;

            const useHeader = document.getElementById('skipHeaderCheck').checked;
            const numCols = data.rows[0].length;

            // Header
            let headerRow = '<tr>';
            if (useHeader && data.headers) {
                data.headers.forEach((h, i) => {
                    headerRow += `<th class="clickable-header" onclick="selectColumn(${i}, this)">${h}</th>`;
                });
            } else {
                for (let i = 0; i < numCols; i++) {
                    headerRow += `<th class="clickable-header" onclick="selectColumn(${i}, this)">Column ${i}</th>`;
                }
            }
            headerRow += '</tr>';
            thead.innerHTML = headerRow;

            // Body
            const startRow = useHeader ? 1 : 0;
            data.rows.slice(startRow).forEach(row => {
                let tr = '<tr>';
                row.forEach(cell => {
                    tr += `<td>${cell}</td>`;
                });
                tr += '</tr>';
                tbody.innerHTML += tr;
            });

            // Re-apply selection
            const headers = document.querySelectorAll('.clickable-header');
            selectedColIndices.forEach(idx => {
                if (headers[idx]) {
                    headers[idx].classList.add('selected');
                }
            });
        }

        function selectColumn(index, headerElement) {
            const idx = selectedColIndices.indexOf(index);
            if (idx > -1) {
                selectedColIndices.splice(idx, 1);
                headerElement.classList.remove('selected');
            } else {
                selectedColIndices.push(index);
                headerElement.classList.add('selected');
            }
            selectedColIndices.sort((a, b) => a - b);

            document.getElementById('targetColumnInput').value = selectedColIndices.join(',');
            document.getElementById('selectedColIndex').innerText = selectedColIndices.length > 0 ? selectedColIndices.join(', ') : '-';
            document.getElementById('step2NextBtn').disabled = selectedColIndices.length === 0;
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const conf = await response.json();

                if (!document.getElementById('confHost').value) document.getElementById('confHost').value = conf.host || '';
                if (!document.getElementById('confPort').value) document.getElementById('confPort').value = conf.port || '443';
                if (!document.getElementById('confUser').value) document.getElementById('confUser').value = conf.userName || '';
                if (!document.getElementById('policyInput').value) document.getElementById('policyInput').value = conf.policyName || '';
                if (!document.getElementById('confToken').value) document.getElementById('confToken').value = conf.token || '';

                if (conf.token) originalToken = conf.token;
            } catch (e) {
                console.error(e);
            }
        }

        function updateSummary() {
            document.getElementById('summaryFile').innerText = document.getElementById('fileInput').files[0].name;
            document.getElementById('summaryMode').innerText = document.querySelector('input[name="mode"]:checked').value.toUpperCase();
            document.getElementById('summaryCol').innerText = selectedColIndices.join(', ');
            document.getElementById('summaryPolicy').innerText = document.getElementById('policyInput').value;
        }

        function runProcess() {
            document.getElementById('step4Controls').classList.add('d-none');
            document.getElementById('processingStatus').classList.remove('d-none');
            // Reset Progress UI
            document.getElementById('uploadProgressContainer').classList.remove('d-none');
            document.getElementById('uploadProgressBar').style.width = '0%';
            document.getElementById('uploadProgressBar').innerText = '0%';
            document.getElementById('serverProcessingContainer').classList.add('d-none');
            document.getElementById('executionError').classList.add('d-none');

            const formData = new FormData();
            formData.append("file", document.getElementById('fileInput').files[0]);
            formData.append("mode", document.querySelector('input[name="mode"]:checked').value);
            formData.append("columns", selectedColIndices.join(','));
            formData.append("policy", document.getElementById('policyInput').value);
            formData.append("delimiter", document.getElementById('delimiterInput').value);
            formData.append("skipHeader", document.getElementById('skipHeaderCheck').checked);

            formData.append("confHost", document.getElementById('confHost').value);
            formData.append("confPort", document.getElementById('confPort').value);
            formData.append("confUser", document.getElementById('confUser').value);

            const tokenVal = document.getElementById('confToken').value;
            if (tokenVal && tokenVal !== "******") {
                formData.append("confToken", tokenVal);
            }

            // Thread Count
            formData.append("threadCount", document.getElementById('threadCountInput').value);

            // Use XMLHttpRequest for Upload Progress
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/process");

            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const bar = document.getElementById('uploadProgressBar');
                    bar.style.width = percentComplete + '%';
                    bar.innerText = percentComplete + '%';
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const result = JSON.parse(xhr.responseText);
                    startPolling(result.jobId);
                } else {
                    let errMsg = "Processing failed";
                    try {
                        const err = JSON.parse(xhr.responseText);
                        errMsg = err.error || errMsg;
                    } catch (e) { }
                    showError(errMsg);
                }
            };

            xhr.onerror = function () {
                showError("Network Error");
            };

            xhr.send(formData);
        }

        function startPolling(jobId) {
            // Switch UI to Processing mode
            document.getElementById('uploadProgressContainer').classList.add('d-none');
            document.getElementById('serverProcessingContainer').classList.remove('d-none');

            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/status/${jobId}`);
                    if (!res.ok) throw new Error("Status check failed");

                    const status = await res.json();

                    // Update Status UI
                    document.getElementById('procLines').innerText = status.processedLines;
                    if (status.totalLines > 0) {
                        document.getElementById('procTotal').innerText = status.totalLines;
                        document.getElementById('totalLinesContainer').classList.remove('d-none');
                    }

                    if (status.errorCount > 0) {
                        document.getElementById('procErrors').innerText = status.errorCount;
                        document.getElementById('procErrorsContainer').style.display = 'block';
                    }

                    if (status.status === 'COMPLETED') {
                        clearInterval(pollInterval);
                        showResult(status);
                    } else if (status.status === 'FAILED') {
                        clearInterval(pollInterval);
                        showError(status.errorMessage || "Processing failed on server.");
                    }
                } catch (e) {
                    console.error("Polling error", e);
                    // Don't stop immediately on network glitch, maybe count errors?
                }
            }, 1000); // Poll every 1 second
        }

        function showError(msg) {
            document.getElementById('executionError').innerText = "Error: " + msg;
            document.getElementById('executionError').classList.remove('d-none');
            document.getElementById('step4Controls').classList.remove('d-none');
            document.getElementById('processingStatus').classList.add('d-none');
        }

        async function showResult(jobStatus) {
            goToStep(5);
            document.getElementById('downloadLink').href = `/api/download/${jobStatus.resultToken}`;

            document.getElementById('statStartTime').innerText = jobStatus.startTime;
            document.getElementById('statEndTime').innerText = jobStatus.endTime;
            document.getElementById('statDuration').innerText = jobStatus.duration;
            document.getElementById('statLines').innerText = jobStatus.processedLines;
            document.getElementById('statErrors').innerText = jobStatus.errorCount;
            document.getElementById('processingStats').classList.remove('d-none');

            // Fetch preview
            try {
                const res = await fetch(`/api/preview-result/${jobStatus.resultToken}`);
                const preview = await res.json();

                let content = "";
                if (preview.rows) {
                    preview.rows.forEach(r => content += r + "\n");
                }
                document.getElementById('resultPreviewContent').innerText = content;
            } catch (e) {
                document.getElementById('resultPreviewContent').innerText = "Preview unavailable.";
            }
        }
    </script>

    <script src="/js/bootstrap.bundle.min.js"></script>
</body>

</html>